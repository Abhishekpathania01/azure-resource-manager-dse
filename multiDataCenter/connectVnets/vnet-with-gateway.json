{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"location": {
			"type": "string",
			"allowedValues": [
				"Central US",
				"North Europe"
			],
			"metadata": {
				"description": "The region to deploy the resources into"
			}
		},
		"virtualNetworkName": {
			"type": "string",
			"metadata": {
				"description": "The name of the Virtual Network"
			}
		},
		"gatewayName": {
			"type": "string",
			"metadata": {
				"description": "The name of the Virtual Network Gateway"
			},
			"defaultValue":"[concat(parameters('virtualNetworkName'),'-gateway')]"
		},
		"virtualNetworkAddressRange": {
			"type": "string",
			"metadata": {
				"description": "The address range of the VNET in CIDR format"
			},
			"defaultValue":"10.0.0.0/16"
		},
		"subnets": {
			"type": "array",
			"metadata": {
				"description": "The subnet definition for the VNET"
			},
			"defaultValue":[
			{
				"name": "Subnet-1",
				"properties": {
					"addressPrefix": "10.0.0.0/24"
				}
			},
			{
				"name": "GatewaySubnet",
				"properties": {
					"addressPrefix": "10.0.1.0/24"
				}
			}
			]
		}, 
		"localGatewayName": {
			"type": "string",
			"metadata": {
				"description": "The name of the Local Gateway to Create"
			}			
		},
		"localGatewayIPAddress": {
			"type": "string",
			"metadata": {
				"description": "The IP Address of the local Gateway"
			},
			"defaultValue":"191.239.208.143"			
		},
		"localGatewayAddressPrefixes":{
			"type": "array",
			"metadata": {
				"description": "The address space definition for the local network"
			},
			"defaultValue":[
				"10.0.0.0/22"
			]
		},
		"gatewaySharedKey" :{
			"type": "string",
			"metadata": {
				"description": "The IP Address of the local Gateway"
			}
		}
	},
	"variables": {
		"vnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
		"vnetGatewayID": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('gatewayName'))]",
		"localGatewayID": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('localGatewayName'))]",
		"gwSubnetRef": "[concat(variables('vnetID'),'/subnets/GatewaySubnet')]",
	},	
	"resources": [
		{
			"name": "[parameters('virtualNetworkName')]",
			"type": "Microsoft.Network/virtualNetworks",
			"location": "[parameters('location')]",
			"apiVersion": "2015-05-01-preview",
			"properties": {
				"addressSpace": {
				"addressPrefixes": [
					"[parameters('virtualNetworkAddressRange')]"
				]
				},
				"subnets": "[parameters('subnets')]"
			}
		},
		{
	      "name": "[parameters('localGatewayName')]",
	      "type": "Microsoft.Network/localNetworkGateways",
		  "location": "[parameters('location')]",xv
		  "apiVersion": "2015-05-01-preview",
		  "properties": {
	        "localNetworkSiteAddressSpace": {
      			"addressPrefixes": "[parameters('localGatewayAddressPrefixes')]"
			},
	        "gatewayIpAddress": "[parameters('localGatewayIPAddress')]"
	      }
		  
    	},
		{
			"apiVersion": "2015-05-01-preview",
			"type": "Microsoft.Network/publicIPAddresses",
			"name": "GWIPAddress",
			"location": "[parameters('location')]",
			"properties": {
				"publicIPAllocationMethod": "Dynamic"
			}
		},
		{
            "apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/virtualNetworkGateways",
            "name": "[parameters('gatewayName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "Microsoft.Network/publicIPAddresses/GWIPAddress",
				 "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[variables('gwSubnetRef')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses','GWIPAddress')]"
                            }
                        },
                        "name": "vnetGatewayConfig"
                    }
                ],
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": false
            }
		},
		{
			"apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/connections",
            "name": "[concat(parameters('gatewayName'),'-',parameters('localGatewayName'))]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[parameters('gatewayName')]",
				"[parameters('localGatewayName')]",
            ],				
			"properties": {
				"virtualNetworkGateway1": {
					"id": "[variables('vnetGatewayID')]"
				},
				"localNetworkGateway2": {
					"id": "[variables('localGatewayID')]"
				},
				"connectionType": "IPsec",
				"sharedKey": "[parameters('gatewaySharedKey')]"
			}
		}
	]
}