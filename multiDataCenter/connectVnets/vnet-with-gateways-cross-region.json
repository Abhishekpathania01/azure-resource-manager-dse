{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"location1": {
			"type": "string",
			"metadata": {
				"description": "The region to deploy the resources into"
			},
			"defaultValue" : "West US"
		},
		"location2": {
			"type": "string",
			"metadata": {
				"description": "The region to deploy the resources into"
			},
			"defaultValue" : "East US"
		},
		"virtualNetworkName1": {
			"type": "string",
			"metadata": {
				"description": "The name of the Virtual Network"
			},
			"defaultValue" : "myVNET1"
		},
		"virtualNetworkName2": {
			"type": "string",
			"metadata": {
				"description": "The name of the Virtual Network"
			},
			"defaultValue" : "myVNET2"
		},
		"gatewayName1": {
			"type": "string",
			"metadata": {
				"description": "The name of the Virtual Network Gateway"
			},
			"defaultValue":"[concat(parameters('virtualNetworkName1'),'-gateway')]"
		},
		"virtualNetworkAddressRange1": {
			"type": "string",
			"metadata": {
				"description": "The address range of the VNET in CIDR format"
			},
			"defaultValue":"10.0.0.0/16"
		},
		"gatewayName2": {
			"type": "string",
			"metadata": {
				"description": "The name of the Virtual Network Gateway"
			},
			"defaultValue":"[concat(parameters('virtualNetworkName2'),'-gateway')]"
		},
		"virtualNetworkAddressRange2": {
			"type": "string",
			"metadata": {
				"description": "The address range of the VNET in CIDR format"
			},
			"defaultValue":"10.1.0.0/16"
		},
		"subnets1": {
			"type": "array",
			"metadata": {
				"description": "The subnet definition for the VNET"
			},
			"defaultValue":[
			{
				"name": "Subnet-1",
				"properties": {
					"addressPrefix": "10.0.0.0/24"
				}
			},
			{
				"name": "GatewaySubnet",
				"properties": {
					"addressPrefix": "10.0.5.0/24"
				}
			}
			]
		}, 
		"subnets2": {
			"type": "array",
			"metadata": {
				"description": "The subnet definition for the VNET"
			},
			"defaultValue":[
			{
				"name": "Subnet-1",
				"properties": {
					"addressPrefix": "10.1.0.0/24"
				}
			},
			{
				"name": "GatewaySubnet",
				"properties": {
					"addressPrefix": "10.1.5.0/24"
				}
			}
			]
		}, 
		"localGatewayName1": {
			"type": "string",
			"metadata": {
				"description": "The name of the Local Gateway to Create"
			},
			"defaultValue" : "localGateway1"			
		},
		"localGatewayName2": {
			"type": "string",
			"metadata": {
				"description": "The name of the Local Gateway to Create"
			},
			"defaultValue" : "localGateway2"			
		},
		"localGatewayAddressPrefixes1":{
			"type": "array",
			"metadata": {
				"description": "The address space definition for the local network"
			},
			"defaultValue":[
				"10.0.0.0/16"
			]
		},
		"localGatewayAddressPrefixes2":{
			"type": "array",
			"metadata": {
				"description": "The address space definition for the local network"
			},
			"defaultValue":[
				"10.1.0.0/16"
			]
		},
		"gatewaySharedKey" :{
			"type": "string",
			"metadata": {
				"description": "The IP Address of the local Gateway"
			},
			"defaultValue" : "abc123"
		}
	},
	"variables": {
		"vnetID1": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName1'))]",
		"vnetGatewayID1": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('gatewayName1'))]",
		"localGatewayID1": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('localGatewayName1'))]",
		"gwIPAddressID1": "[resourceId('Microsoft.Network/publicIPAddresses','GWIPAddress1')]",
		"gwSubnetRef1": "[concat(variables('vnetID1'),'/subnets/GatewaySubnet')]",

		"vnetID2": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName2'))]",
		"vnetGatewayID2": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('gatewayName2'))]",
		"localGatewayID2": "[resourceId('Microsoft.Network/localNetworkGateways', parameters('localGatewayName2'))]",
		"gwIPAddressID2": "[resourceId('Microsoft.Network/publicIPAddresses','GWIPAddress2')]",
		"gwSubnetRef2": "[concat(variables('vnetID2'),'/subnets/GatewaySubnet')]"
	},	
	"resources": [
		{
			"name": "[parameters('virtualNetworkName1')]",
			"type": "Microsoft.Network/virtualNetworks",
			"location": "[parameters('location1')]",
			"apiVersion": "2015-05-01-preview",
			"properties": {
				"addressSpace": {
				"addressPrefixes": [
					"[parameters('virtualNetworkAddressRange1')]"
				]
				},
				"subnets": "[parameters('subnets1')]"
			}
		},
		{
			"name": "[parameters('virtualNetworkName2')]",
			"type": "Microsoft.Network/virtualNetworks",
			"location": "[parameters('location2')]",
			"apiVersion": "2015-05-01-preview",
			"properties": {
				"addressSpace": {
				"addressPrefixes": [
					"[parameters('virtualNetworkAddressRange2')]"
				]
				},
				"subnets": "[parameters('subnets2')]"
			}
		},
		{
			"apiVersion": "2015-05-01-preview",
			"type": "Microsoft.Network/publicIPAddresses",
			"name": "GWIPAddress1",
			"location": "[parameters('location1')]",
			"properties": {
				"publicIPAllocationMethod": "Dynamic"
			}
		},
		{
			"apiVersion": "2015-05-01-preview",
			"type": "Microsoft.Network/publicIPAddresses",
			"name": "GWIPAddress2",
			"location": "[parameters('location2')]",
			"properties": {
				"publicIPAllocationMethod": "Dynamic"
			}
		},
		{
            "apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/virtualNetworkGateways",
            "name": "[parameters('gatewayName1')]",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "Microsoft.Network/publicIPAddresses/GWIPAddress1",
				 "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName1'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[variables('gwSubnetRef1')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses','GWIPAddress1')]"
                            }
                        },
                        "name": "vnetGatewayConfig"
                    }
                ],
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": false
            }
		},
		{
            "apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/virtualNetworkGateways",
            "name": "[parameters('gatewayName2')]",
            "location": "[parameters('location2')]",
            "dependsOn": [
                "Microsoft.Network/publicIPAddresses/GWIPAddress2",
				 "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName2'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[variables('gwSubnetRef2')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses','GWIPAddress2')]"
                            }
                        },
                        "name": "vnetGatewayConfig"
                    }
                ],
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": false
            }
		},
		{
			"apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/connections",
            "name": "connection1",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('gatewayName1'))]",
            	"[concat('Microsoft.Network/virtualNetworkGateways/', parameters('gatewayName2'))]"
            ],				
			"properties": {
				"virtualNetworkGateway1": {
					"id": "[variables('vnetGatewayID1')]"
				},
				"virtualNetworkGateway2": {
					"id": "[variables('vnetGatewayID2')]"
				},
				"connectionType": "Vnet2Vnet",
                "routingWeight": 3,
				"sharedKey": "[parameters('gatewaySharedKey')]"
			}
		},
		{
			"apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/connections",
            "name": "connection2",
            "location": "[parameters('location2')]",
            "dependsOn": [
            	"[concat('Microsoft.Network/virtualNetworkGateways/', parameters('gatewayName1'))]",
            	"[concat('Microsoft.Network/virtualNetworkGateways/', parameters('gatewayName2'))]"
            ],				
			"properties": {
				"virtualNetworkGateway1": {
					"id": "[variables('vnetGatewayID2')]"
				},
				"virtualNetworkGateway2": {
					"id": "[variables('vnetGatewayID1')]"
				},
				"connectionType": "Vnet2Vnet",
                "routingWeight": 3,
				"sharedKey": "[parameters('gatewaySharedKey')]"
			}
		}
	]
}